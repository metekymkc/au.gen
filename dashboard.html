<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mete's Admin Konsole</title>
    <style>
        :root {
            --bg: #09090b; --card: #18181b; --overlay: rgba(0,0,0,0.85);
            --text: #f4f4f5; --text-muted: #a1a1aa;
            --primary: #3b82f6; --primary-hover: #2563eb;
            --border: #27272a; --input-bg: #27272a; --danger: #ef4444; --success: #10b981;
            --radius: 12px;
        }
        * { box-sizing: border-box; }
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Segoe UI', Inter, sans-serif; margin: 0; padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }

        /* HEADER & TABS */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border);
        }
        h1 { margin: 0; font-size: 1.5rem; }
        
        .tabs { display: flex; gap: 10px; background: #141417; padding: 5px; border-radius: var(--radius); border: 1px solid var(--border); }
        .tab-btn {
            background: transparent; color: var(--text-muted); border: none;
            padding: 10px 20px; cursor: pointer; border-radius: 8px; font-weight: 600;
            transition: all 0.2s;
        }
        .tab-btn.active { background: var(--card); color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* VIEWS */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & GRIDS */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width: 900px) { .config-grid { grid-template-columns: 1fr; } }

        h2 { margin-top: 0; font-size: 1.1rem; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }

        /* TABLES & LISTS */
        .item-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .config-item {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .config-info { display: flex; flex-direction: column; gap: 2px; }
        .config-title { font-weight: 600; font-size: 0.95rem; }
        .config-sub { font-size: 0.8rem; color: var(--text-muted); }

        /* FORMS */
        input, select, textarea {
            background: var(--input-bg); border: 1px solid var(--border); color: white;
            padding: 10px; border-radius: 6px; width: 100%; outline: none; margin-bottom: 10px;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        label { font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px; }

        /* BUTTONS */
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 16px;
            border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
        }
        .btn:hover { background: var(--primary-hover); }
        .btn-sm { padding: 6px 10px; font-size: 0.8rem; }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-success { background: var(--success); }

        /* LOGIN & MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay); z-index: 1000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; }
        
        .login-box { 
            padding: 40px; text-align: center; max-width: 350px; 
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px;
            box-shadow: 0 0 60px rgba(0,0,0,0.6);
        }
        .login-box input { background: transparent; text-align: center; margin: 20px 0; }

        /* JSON EDITOR STYLE */
        .json-editor {
            font-family: 'Courier New', monospace; font-size: 0.85rem;
            min-height: 200px; resize: vertical; line-height: 1.4;
        }

        /* Task Cards (from previous version) */
        .task-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .task-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; cursor: pointer; transition: 0.2s; }
        .task-card:hover { border-color: #52525b; transform: translateY(-2px); }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-overlay active">
        <div class="login-box">
            <h3>ðŸ”’ Admin Access</h3>
            <input type="password" id="passwordInput" placeholder="Passwort...">
            <button class="btn" style="width:100%" onclick="login()">Login</button>
        </div>
    </div>

    <div class="container">
        <header>
            <div style="display:flex; gap:15px; align-items:center;">
                <h1>Mete's Konsole</h1>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('orders')">AuftrÃ¤ge</button>
                    <button class="tab-btn" onclick="switchTab('config')">Datenbank & Config</button>
                </div>
            </div>
            <button class="btn btn-sm btn-danger" onclick="location.reload()">Logout</button>
        </header>

        <div id="view-orders" class="view-section active">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <input type="text" id="searchOrders" placeholder="Suche..." style="max-width:300px;">
                <button class="btn btn-sm" onclick="loadOrders()">â†» Refresh</button>
            </div>
            <div id="orderGrid" class="task-grid">
                <div style="text-align:center; color:gray; grid-column:1/-1;">Lade AuftrÃ¤ge...</div>
            </div>
        </div>

        <div id="view-config" class="view-section">
            <div class="config-grid">
                
                <div class="card">
                    <h2>Ã„rzte <button class="btn btn-sm" onclick="addDoctor()">+ Neu</button></h2>
                    <div class="item-list" id="doctorList"></div>
                </div>

                <div class="card">
                    <h2>Versicherungen <button class="btn btn-sm" onclick="addInsurance()">+ Neu</button></h2>
                    <div class="item-list" id="insuranceList"></div>
                </div>

                <div class="card" style="grid-column: 1 / -1;">
                    <h2>Templates & Koordinaten</h2>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="newTemplateId" placeholder="Template ID (z.B. neu_template)">
                        <input type="file" id="pdfUpload" accept="application/pdf">
                        <button class="btn" onclick="uploadTemplate()">Upload PDF</button>
                    </div>
                    
                    <label>Koordinaten-Konfiguration (JSON):</label>
                    <textarea id="configJson" class="json-editor"></textarea>
                    <button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="saveConfig()">ðŸ’¾ Ã„nderungen Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WORKER_URL = "https://pdf-worker.metekymkc.workers.dev";
        let AUTH_KEY = "";
        let DB = { doctors: [], insurances: [], templates: {} };

        // --- AUTH ---
        async function login() {
            AUTH_KEY = document.getElementById('passwordInput').value;
            // Test Login by fetching config
            try {
                const res = await fetch(`${WORKER_URL}/admin/config`, { headers: { 'x-admin-auth': AUTH_KEY } });
                if (res.status === 401) { alert("Falsches Passwort"); return; }
                
                DB = await res.json();
                document.getElementById('login-modal').style.display = 'none';
                renderConfig();
                loadOrders(); // Load orders in background
            } catch (e) { alert("Fehler beim Verbinden: " + e); }
        }

        // --- NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`view-${tab}`).classList.add('active');
            event.target.classList.add('active');
        }

        // --- CONFIGURATION LOGIC ---
        function renderConfig() {
            // Doctors
            const docList = document.getElementById('doctorList');
            docList.innerHTML = "";
            DB.doctors.forEach((doc, idx) => {
                docList.innerHTML += `
                    <div class="config-item">
                        <div class="config-info">
                            <span class="config-title">${doc.name}</span>
                            <span class="config-sub">${doc.citySearch} | ${doc.templateId}</span>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeDoctor(${idx})">âœ•</button>
                    </div>
                `;
            });

            // Insurances
            const insList = document.getElementById('insuranceList');
            insList.innerHTML = "";
            DB.insurances.forEach((ins, idx) => {
                insList.innerHTML += `
                    <div class="config-item">
                        <div class="config-info">
                            <span class="config-title">${ins.name}</span>
                            <span class="config-sub">Code: ${ins.code} | Grp: ${ins.group}</span>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeInsurance(${idx})">âœ•</button>
                    </div>
                `;
            });

            // JSON Editor
            document.getElementById('configJson').value = JSON.stringify(DB.templates, null, 2);
        }

        async function saveConfig() {
            // Parse JSON Area for Templates
            try {
                const templates = JSON.parse(document.getElementById('configJson').value);
                DB.templates = templates;
            } catch (e) { alert("Fehler im JSON Format!"); return; }

            // Save to Worker
            const res = await fetch(`${WORKER_URL}/admin/config`, {
                method: 'POST',
                headers: { 'x-admin-auth': AUTH_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify(DB)
            });
            if (res.ok) alert("Gespeichert!");
            else alert("Fehler beim Speichern");
        }

        // --- EDIT FUNCTIONS ---
        function addDoctor() {
            const name = prompt("Name der Praxis:");
            const details = prompt("Details (z.B. Dr. MÃ¼ller):");
            const city = prompt("Stadt (Suchbegriff klein):");
            const tpl = prompt("Template ID (z.B. base_template):");
            if(name && city) {
                DB.doctors.push({ id: Date.now().toString(), name, details, citySearch: city.toLowerCase(), templateId: tpl });
                renderConfig();
            }
        }
        function removeDoctor(idx) { DB.doctors.splice(idx, 1); renderConfig(); }

        function addInsurance() {
            const name = prompt("Name der Kasse:");
            const code = prompt("Code (z.B. 12):");
            const group = prompt("Gruppe (AOK, Ersatzkassen...):");
            if(name && code) {
                DB.insurances.push({ name, code, group });
                renderConfig();
            }
        }
        function removeInsurance(idx) { DB.insurances.splice(idx, 1); renderConfig(); }

        // --- UPLOAD ---
        async function uploadTemplate() {
            const id = document.getElementById('newTemplateId').value;
            const file = document.getElementById('pdfUpload').files[0];
            if(!id || !file) return alert("Bitte ID und Datei wÃ¤hlen");

            const res = await fetch(`${WORKER_URL}/admin/template?filename=${id}.pdf`, {
                method: 'PUT',
                headers: { 'x-admin-auth': AUTH_KEY },
                body: file
            });

            if(res.ok) {
                alert("Upload erfolgreich! FÃ¼ge nun die Koordinaten im JSON hinzu.");
                // Add skeleton to JSON if not exists
                if(!DB.templates[id]) {
                    DB.templates[id] = { filename: `${id}.pdf`, positions: { /* Copy from base */ } };
                    renderConfig();
                }
            } else {
                alert("Upload failed");
            }
        }

        // --- ORDER VIEW (Vom alten Dashboard Ã¼bernommen/vereinfacht) ---
        async function loadOrders() {
            const listRes = await fetch(`${WORKER_URL}/admin/list`, { headers: { 'x-admin-auth': AUTH_KEY } });
            const listData = await listRes.json();
            const jsonFiles = listData.objects.filter(obj => obj.key.endsWith('.json')).sort((a,b) => new Date(b.uploaded) - new Date(a.uploaded));
            
            const grid = document.getElementById('orderGrid');
            grid.innerHTML = "";
            
            // Einfache Darstellung der letzten 50
            jsonFiles.slice(0, 50).forEach(file => {
                // Wir laden hier nur den Key/Zeit, Details per Klick wÃ¤re besser (wie vorher),
                // aber der Code wird sonst zu lang. Hier einfache Anzeige:
                const date = new Date(file.uploaded).toLocaleString();
                const namePart = file.key.split('_').slice(2).join(' ').replace('.json','');
                
                grid.innerHTML += `
                    <div class="task-card" onclick="downloadPDF('${file.key.replace('.json','.pdf')}')">
                        <div style="font-weight:bold;">${namePart}</div>
                        <div style="font-size:0.8rem; color:#aaa;">${date}</div>
                        <div style="margin-top:10px; font-size:0.8rem; color:var(--primary);">â¬‡ PDF Download</div>
                    </div>
                `;
            });
        }
        
        function downloadPDF(key) {
             const url = `${WORKER_URL}/admin/get?key=${encodeURIComponent(key)}`;
             fetch(url, { headers: { 'x-admin-auth': AUTH_KEY } })
                .then(res => res.blob())
                .then(blob => {
                    const a = document.createElement('a'); a.href = window.URL.createObjectURL(blob);
                    a.download = key; document.body.appendChild(a); a.click(); a.remove();
                });
        }

        // Enter Key Login
        document.getElementById('passwordInput').addEventListener('keypress', e => { if(e.key==='Enter') login(); });

    </script>
</body>
</html>
