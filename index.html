<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AU PDF Generator</title>
<style>
  body { font-family: sans-serif; padding: 2rem; background: #f5f5f5; }
  form { background: #fff; padding: 2rem; border-radius: 8px; max-width: 600px; margin: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  label { display: block; margin-top: 1rem; font-weight: bold; }
  input, select { width: 100%; padding: 0.5rem; margin-top: 0.3rem; border-radius: 4px; border: 1px solid #ccc; }
  button { margin-top: 1.5rem; padding: 0.8rem 1.5rem; border: none; border-radius: 4px; background: #007bff; color: #fff; cursor: pointer; }
  button:hover { background: #0056b3; }
  .address-autocomplete { position: relative; }
  .autocomplete-suggestions { position: absolute; background: #fff; border: 1px solid #ccc; width: 100%; max-height: 150px; overflow-y: auto; z-index: 10; }
  .autocomplete-suggestion { padding: 0.5rem; cursor: pointer; }
  .autocomplete-suggestion:hover { background: #f0f0f0; }
</style>
</head>
<body>

<form id="auForm">
  <label>Vorname</label>
  <input type="text" name="firstName" required>

  <label>Nachname</label>
  <input type="text" name="lastName" required>

  <label>Adresse</label>
  <div class="address-autocomplete">
    <input type="text" name="addressSearch" id="addressSearch" placeholder="Straße Hausnummer, PLZ Stadt, Land" autocomplete="off" required>
    <div id="suggestions" class="autocomplete-suggestions"></div>
  </div>

  <label>Straße</label>
  <input type="text" name="street" id="street" required>

  <label>Hausnummer</label>
  <input type="text" name="houseNumber" id="houseNumber" required>

  <label>Postleitzahl</label>
  <input type="text" name="zip" id="zip" required>

  <label>Stadt</label>
  <input type="text" name="city" id="city" required>

  <label>Krankenkasse</label>
  <select name="insurance" required>
    <option value="">Bitte wählen</option>
    <option value="AOK">AOK</option>
    <option value="TK">TK</option>
    <option value="Barmer">Barmer</option>
  </select>

  <label>Geburtsdatum</label>
  <input type="date" name="birthDate" max="<?= new Date().toISOString().split('T')[0] ?>" required>

  <label>Versichertennummer</label>
  <input type="text" name="insuranceNumber" required>

  <label>Datum der AU</label>
  <input type="date" name="auDate" required>

  <label>Arbeitsunfähig seit</label>
  <input type="date" name="auFrom" required>

  <label>Voraussichtlich arbeitsunfähig bis</label>
  <input type="date" name="auTo" required>

  <label>Festgestellt am</label>
  <input type="date" name="confirmedOn" required>

  <label>Bescheinigungstyp</label>
  <select name="certificateType" required>
    <option value="first">Erstbescheinigung</option>
    <option value="followup">Folgebescheinigung</option>
  </select>

  <button type="submit">PDF Generieren</button>
</form>

<script>
const form = document.getElementById('auForm');
const addressInput = document.getElementById('addressSearch');
const suggestionsEl = document.getElementById('suggestions');

let debounceTimeout;
addressInput.addEventListener('input', () => {
  const query = addressInput.value;
  clearTimeout(debounceTimeout);
  if(!query) { suggestionsEl.innerHTML = ''; return; }

  debounceTimeout = setTimeout(async () => {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(query)}`);
    const data = await res.json();
    suggestionsEl.innerHTML = '';
    data.slice(0,5).forEach(place => {
      const div = document.createElement('div');
      div.className = 'autocomplete-suggestion';
      div.textContent = place.display_name;
      div.onclick = () => {
        // Fill individual fields for PDF
        const addr = place.address;
        document.getElementById('street').value = addr.road || '';
        document.getElementById('houseNumber').value = (addr.house_number || '').toUpperCase();
        document.getElementById('zip').value = addr.postcode || '';
        document.getElementById('city').value = addr.city || addr.town || addr.village || '';
        suggestionsEl.innerHTML = '';
        addressInput.value = div.textContent;
      };
      suggestionsEl.appendChild(div);
    });
  }, 300);
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(form);
  const body = Object.fromEntries(formData.entries());

  // Compose short address for PDF
  let streetPdf = body.street;
  if(streetPdf.toLowerCase().includes('straße')) streetPdf = streetPdf.replace(/straße/i, 'str.');
  body.addressForPDF = `${streetPdf} ${body.houseNumber.toUpperCase()}, ${body.zip} ${body.city}, D`;

  try {
    const res = await fetch('https://pdf-worker.metekymkc.workers.dev/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'AU.pdf';
    a.click();
    URL.revokeObjectURL(url);
  } catch (err) {
    alert('Fehler beim Generieren des PDFs: ' + err);
    console.error(err);
  }
});
</script>
</body>
</html>
