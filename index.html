<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>AU Generator</title>
<style>
  body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
  label { display: block; margin-top: 10px; }
  input, select { padding: 5px; width: 300px; }
  #autocomplete-list { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; background: #fff; position: absolute; z-index: 1000; }
  #autocomplete-list div { padding: 5px; cursor: pointer; }
  #autocomplete-list div:hover { background: #eee; }
  button { margin-top: 20px; padding: 10px 20px; }
</style>
</head>
<body>
<h1>AU PDF Generator</h1>
<form id="auForm">
  <label>Vorname: <input type="text" name="firstName" required></label>
  <label>Nachname: <input type="text" name="lastName" required></label>

  <h3>Adresse</h3>
  <label>Straße: <input type="text" id="street" name="street" required></label>
  <label>Hausnummer: <input type="text" id="houseNumber" name="houseNumber" required></label>
  <label>PLZ: <input type="text" id="zip" name="zip" required></label>
  <label>Stadt: <input type="text" id="city" name="city" required></label>
  <label>Land: <input type="text" id="countryCode" name="countryCode" value="D" required></label>

  <label>Krankenkasse:
    <select name="insurance" required>
      <option value="AOK">AOK</option>
      <option value="TK">TK</option>
      <option value="Barmer">Barmer</option>
    </select>
  </label>

  <label>Geburtsdatum: <input type="date" name="birthDate" max="<?= new Date().toISOString().split('T')[0] ?>" required></label>
  <label>Versichertennummer: <input type="text" name="insuranceNumber" required></label>

  <h3>AU Daten</h3>
  <label>Datum AU erstellt: <input type="date" name="auDate" max="<?= new Date().toISOString().split('T')[0] ?>" required></label>
  <label>Arbeitsunfähig seit: <input type="date" name="auFrom" max="<?= new Date().toISOString().split('T')[0] ?>" required></label>
  <label>Voraussichtlich arbeitsunfähig bis: <input type="date" name="auTo" max="<?= new Date().toISOString().split('T')[0] ?>" required></label>
  <label>Festgestellt am: <input type="date" name="confirmedOn" max="<?= new Date().toISOString().split('T')[0] ?>" required></label>

  <label>Bescheinigung:
    <select name="certificateType" required>
      <option value="first">Erstbescheinigung</option>
      <option value="followup">Folgebescheinigung</option>
    </select>
  </label>

  <button type="submit">PDF generieren</button>
</form>

<script>
const streetInput = document.getElementById('street');
const houseInput = document.getElementById('houseNumber');
const zipInput = document.getElementById('zip');
const cityInput = document.getElementById('city');
const countryInput = document.getElementById('countryCode');

let currentFocus;

streetInput.addEventListener('input', async function() {
  const val = this.value;
  closeAllLists();
  if (!val) return false;

  const listContainer = document.createElement("div");
  listContainer.setAttribute("id", "autocomplete-list");
  this.parentNode.appendChild(listContainer);

  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(val)}`);
  const data = await res.json();

  data.forEach(item => {
    const div = document.createElement("div");
    div.innerHTML = item.display_name;
    div.addEventListener("click", function() {
      if(item.address) {
        streetInput.value = item.address.road || '';
        houseInput.value = item.address.house_number || '';
        zipInput.value = item.address.postcode || '';
        cityInput.value = item.address.city || item.address.town || item.address.village || '';
        countryInput.value = item.address.country_code ? item.address.country_code.toUpperCase() : 'D';
      }
      closeAllLists();
    });
    listContainer.appendChild(div);
  });
});

function closeAllLists() {
  const lists = document.getElementsByClassName("autocomplete-items");
  for (let i = 0; i < lists.length; i++) {
    lists[i].parentNode.removeChild(lists[i]);
  }
  const oldList = document.getElementById("autocomplete-list");
  if (oldList) oldList.parentNode.removeChild(oldList);
}

document.getElementById('auForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const jsonData = {};
  formData.forEach((value, key) => jsonData[key] = value);

  const res = await fetch('https://pdf-worker.metekymkc.workers.dev/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(jsonData)
  });

  if (res.ok) {
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'AU.pdf';
    a.click();
    URL.revokeObjectURL(url);
  } else {
    alert("PDF konnte nicht erstellt werden.");
  }
});
</script>
</body>
</html>
