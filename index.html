<script>
  const WORKER_URL = "https://pdf-worker.metekymkc.workers.dev"; // Anpassen falls nötig
  
  // Datum maximal heute setzen
  const today = new Date().toISOString().split("T")[0];
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[type="date"]').forEach(input => {
      input.setAttribute('max', today);
    });
  });

  // ===== Autocomplete OpenStreetMap (Optimiert) =====
  const searchInput = document.getElementById('address-search');
  const suggestionBox = document.getElementById('address-suggestions');

  let timeout;
  searchInput.addEventListener('input', () => {
    clearTimeout(timeout);
    const query = searchInput.value;
    if (!query) { suggestionBox.innerHTML = ''; return; }

    timeout = setTimeout(async () => {
      // WICHTIG: &accept-language=de erzwingt deutsche Namen (München statt Munich)
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5&countrycodes=DE&accept-language=de`;
      
      try {
        const res = await fetch(url);
        const data = await res.json();
        suggestionBox.innerHTML = '';

        data.forEach(place => {
          const addr = place.address;

          // Wir bauen uns die Anzeige selbst zusammen, damit sie kurz ist
          const road = addr.road || addr.pedestrian || addr.cycleway || '';
          const number = addr.house_number || '';
          const zip = addr.postcode || '';
          const city = addr.city || addr.town || addr.village || '';
          
          // Wenn keine Straße gefunden wurde, überspringen wir das Ergebnis oft besser
          if (!road) return;

          // Das ist der Text, den der User im Vorschlag sieht
          // Format: Musterstraße 12, 80331 München
          const displayText = `${road} ${number}, ${zip} ${city}`.trim().replace(/,$/, '');

          const div = document.createElement('div');
          div.textContent = displayText; // Kurze, saubere Anzeige
          div.style.cursor = "pointer";
          div.style.padding = "5px";

          div.addEventListener('click', () => {
            // Formularfelder befüllen
            document.getElementById('street').value = road;
            document.getElementById('house_number').value = number;
            document.getElementById('postcode').value = zip;
            document.getElementById('city').value = city;
            document.getElementById('country').value = "Deutschland";

            // Suchfeld leeren oder mit der Auswahl füllen (Geschmackssache)
            searchInput.value = displayText; 
            suggestionBox.innerHTML = '';
          });

          suggestionBox.appendChild(div);
        });
      } catch (e) {
        console.error("OSM Fehler", e);
      }
    }, 300);
  });

  // Schließen der Vorschläge beim Klick woanders hin
  document.addEventListener('click', e => {
    if (!e.target.closest('.address-container')) suggestionBox.innerHTML = '';
  });

  // ===== PDF Generierung =====
  const form = document.getElementById("pdfForm");
  form.addEventListener("submit", async e => {
    e.preventDefault();
    const fd = new FormData(form);
    const data = Object.fromEntries(fd.entries());

    // HIER KEINE FORMATIERUNG MEHR! 
    // Wir schicken die Daten so wie sie sind an den Worker.

    try {
      const resp = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (!resp.ok) {
         const errText = await resp.text();
         throw new Error(`Server error: ${resp.status} ${errText}`);
      }

      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "au_bescheinigung.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

    } catch (err) {
      alert("Fehler: " + err.message);
    }
  });
</script>
